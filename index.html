<html>    <head>  		<meta charset="utf-8">  		<title>Hunting Threat Actors with TLS Certificates</title>  		<meta name="description" content="A journey in using TLS certificates from censys.io, scans.io and PassiveToal to hunt threat actors and perform computer network defense ">  		<meta name="author" content="Mark Parsons">  		<meta name="apple-mobile-web-app-capable" content="yes">  		<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">  		<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, minimal-ui">  		<link rel="stylesheet" href="css/reveal.css">  		<link rel="stylesheet" href="css/theme/white.css" id="theme">      <link rel="stylesheet" href="css/vis.min.css">  		<!-- Code syntax highlighting -->  		<link rel="stylesheet" href="lib/css/zenburn.css">  		<!-- Printing and PDF exports -->  		<script>  			var link = document.createElement( 'link' );  			link.rel = 'stylesheet';  			link.type = 'text/css';  			link.href = window.location.search.match( /print-pdf/gi ) ? 'css/print/pdf.css' : 'css/print/paper.css';  			document.getElementsByTagName( 'head' )[0].appendChild( link );  		</script>  		<!--[if lt IE 9]>  		<script src="lib/js/html5shiv.js"></script>  		<![endif]-->  	</head>    <body>        <div class="reveal">            <div class="slides">              <!-- Title -->              <section>      					<h1>Hunting Threat Actors with TLS Certificates</h1>      					<h3> Using open source data to defend networks</h3>      					<p>      						<a href="https://github.com/mpars0ns" target="_blank">Mark Parsons</a> / <a href="https://twitter.com/markpars0ns" target="_blank" >@markpars0ns </a>      					</p>      				</section>              <!-- Introduction -->              <section>                  <section>                      <h1>Introduction</h1>                  </section>                  <section>                      <h1>Who am I</h1>                      <h3>Mark Parsons</h3>                      <ul>                        <li>Previous life: </li><ul>            						<li>Incident responder                          <li>Network defender</li>                        <li>Occasional threat analyst</li> </ul>                        <li>Now </li>                          <ul>                          <li>dev ops /intel for <a href="http://www.kingandunion.io/">King & Union</a></li>                        </ul>            						<li>I like to write in <a href="http://www.python.org" target="_blank">python</a> and sometimes <a href="https://golang.org/" target="_blank">go</a></li>            					</ul>                    </section>                  <section >                      <h2>Who am I not</h2>                      <p>Animator - Archer</p>                      <img data-src='images/archer_credits.png'>                  </section>                  <section>                      <h2>One Direction Fan Fiction???</h2>                      <img data-src='images/wired_fan_fict.png'>                  </section>                </section>                <section>                  <section>                  <h2> Traditional methods of hunting / pivoting using network related resources</h2>                </section>                <section>                  <h2> Passive DNS </h2>                  <p> Historical mappings of domains to IP addresses and vice versa </p>                  <p>Sources of PDNS</p>                  <ul>                    <li> <a href="https://www.dnsdb.info/" target="_blank">Farsight  </a></li>                    <li> <a href="http://passivedns.mnemonic.no/" target="_blank"> Mnemonic </a></li>                    <li> <a href="https://www.passivetotal.org/" target="_blank">PassiveTotal</a> </li>                    <li> <a href="https://www.opendns.com/" target="_blank">OpenDns </a></li>                </section>                <section>                  <h2> Whois tracking </h2>                  <p> Using domain registrant information to look for other potentially related domains </p>                  <p> Sources of trackable whois information</p>                  <ul>                    <li> <a href="https://whois.domaintools.com/" target="_blank">DomainTools </a> </li>                    <li> <a href="https://whoisology.com/" target="_blank"> Whoisology </a></li>                    <li> <a href="https://www.passivetotal.org/" target="_blank">PassiveTotal </a> </li>                    <li> <a href="https://www.domainiq.com/" target="_blank">DomainIQ </a></li>                    <li> <a href="http://domainbigdata.com/" target="_blank">Domain Big Data</a> </li>                  </ul>                </section>                </section>              </section>                <section>                  <h3>What else could we do that provides pivotable/trackable data</h3>                </section>                <section>                  <h2 >That's right TLS certificates!!!</h2>                </section>                </section>                <!-- reminder SSL/TLS not code signing -->                <section>                  <section>                  <h2>Quick Caveat</h2>                  <p> Code signing certificate != TLS certificate </p>                  </section>                  <section>                    <h3> Code signing </h3>                    <img data-src="images/chrome_signed.png">                  </section>                  <section>                    <h3> TLS certificate </h3>                    <img data-src="images/google_tls.png">                  </section>                </section>                <section>              <section>                <h3>TLS Hunting Basics</h3>                <h3>Tips to help you get started </h3>              </section>              <section>                <h3> Where to start </h3>
                <ul>                  <li>IP to certifcate</li>                  <li>Certificate to IP</li>                </ul>              </section>              <section>                <h3> IP to cert example </h3>                <p>What certificates have been seen on 185.12.44.51 </p>                <hr>                <p class="fragment fade-in">This will be covered later in the slides </p>              </section>              <section>                <h3> Certificate to IP example </h3>                <p>What IP addresses is a1833c32d5f61d6ef9d1bb0133585112069d770e currently seen on<p>                  <hr>                <p class="fragment fade-in">This will be covered later in the slides </p>              </section>              <section>                <h3> What to consider </h3>                <ul>                  <li>Look at the time frame the certificate was seen on an IP</li>                  <li>Was a certificate seen during malicious activity?</li>                  <li>Do you have malware/implant using TLS?</li>                  <li>How many other hosts are seen using that TLS certificate?</li>                  <li>Expiration dates on certificate</li>                  <li>Issuer                    <ul>                      <li>Self Signed </li>                      <li>Free certificate </li>                      <li>Paid certificate </li>                    </ul>                  </li>                </ul>              </section>          </section>              <!-- network defense -->              <section>                <section>                <h3>Network Defense</h3>              </section>              <section>                <h3>What you can do to defend your networks<h3>              </section>              <section>                <h3>IDS Monitoring - TLS fingerprints </h3>              <ul>                    <li> Suricata</li>                    <li> Bro </li>                    <li> Snort 3 - external <a href="https://github.com/CERT-Polska/snort3-x509-reputation-plugin" target="_blank"> package </a> needed </li>                </ul>                </section>                <section>                <h3>Automate tracking of TLS certs</h3>                  <ul>                    <li><a href="https://passivetotal.org" target="_blank">PassiveTotal</a> Monitoring</li>                    <li><a href="https://censys.io" target="_blank">Censys.io</a> API script</li>                    <li>Your own local sonar or censys.io repo </li>                    <li>Combo of all of these </li>                    <li>Put new ip addresses found into monitoring/blocks as needed</li>                  </ul>              </ul>            </section>              </section>              <section>                <section>                  <h3> More Network defense</h3>                </section>              <section>                <h3>More Like Network Hygiene</h3>                <br>                <p>Most of these you will have to do with your own sonar scan data or <a href="https://censys.io" target="_blank">censys.io</a> data </p>                </section>                <section>                  <h3>Look at your netblocks </h3>                  <ul>                    <li>Use your ASN for a censys.io search</li>                    <li>Use your ASN or subnets if sonar data in elasticsearch</li>                  </ul>                </section>                <section>                  <h3>What to look for </h3>                  <ul>                    <li>Your security appliances</li>                    <li>Remote access management                      <ul>                      <li>HP integrated Lights Out</li>                      <li>Dell Remote Access Card</li></ul>                    </li>                    <li>Websites or services you didn't know about</li>                  </ul>                </section>                <section>                  <h3>Look outside your netblocks</h3>                  <ul>                    <li>Look for ceritifcates for your org not inside your netblocks</li>                    <li>Look for certificates that have email addresses from your org</li>                    <li>Look for certificates who have your org as a Subject Alt Name</li>                    <li>Look for dopplegangers of your org </li>                    <li>Take a look at PassiveTotal keyword searching (DNS, Whois, TLS ) aka brand monitoring</li>                </section>              </section>                <!-- scans.io and censys.io -->                <section>                  <section id="fragments">                  <h3> So TLS certificates you say?</h3>                  <h3> Where do you start? </h3>                  <p> First you need some data </p>                  <img class="fragment" data-src="images/scan_allthethings.jpeg">                </section>                  <section>                  <h3> You could ingest <a href='http://scans.io' target="_blank">scans.io</a> sonar SSL scans</h3>                   <br>                   <p> Checkout my <a href="https://github.com/mpars0ns/scansio-sonar-es" target="_blank"> Python Scansio-Sonar-ES</a> github repo </p>                   <p> Or my <a href="https://github.com/mpars0ns/sonar-es-go" target="_blank"> Golang Sonar-ES-GO</a> github repo </p>                  </section>                  <section>                  <h3> Or use <a href='https://censys.io' target="_blank">censys.io</a></h3>                </section>                <section>                  <h3> Or use <a href='https://passivetotal.org' target="_blank">PassiveTotal</a></h3>                </section>              </section>              <!-- scans.io -->              <section>                <h3><a href="https://scans.io/study/sonar.ssl" target="_blank">Scans.io</a> Sonar SSL  scans</h3>                <p> Scans performed by Rapid7 </p>                <ul>                  <li>Raw data going back to 10/30/2013 </li>                  <li>Easily consumable</li>                  <li>Updated weekly </li>                  <li>Incremental in nature                    <ul>                      <li>certs.gz - Only new sha1s and base64 raw certificate seen that week </li>                      <li>hosts.gz - SHA1 and host for all hosts seen </li>                    </ul>                  </li>                  <li>No public search interface </li>                  <li>Is weekly frequent enough ?</li>              </section>              <!-- censys.io -->              <section>                <h3><a href="https://censys.io/" target="_blank">Censys.io</a></h3>                <p> Maintained by the University of Michigan and University of Illinois Urbana-Champaign</p>                <ul>                  <li>Easy to use search interface</li>                  <li>API Access</li>                  <li>Frequent Updates</li>                  <li>All or nothing in nature                    <ul>                      <li>If there is a delta between scans</li                        <li>old scan data is not in main search interface</li>                      <li>Old scan data is available in json format</li>                    </ul>                  </li>                </ul>              </section>              <!-- passive total -->              <section>                <section>                <h3><a href="https://passivetotal.org/" target="_blank">PassiveTotal</a></h3>                <ul>                  <li>Should be the first place any analyst goes when performing any infrastructure hunting</li>                  <li>Merge traditional hunting with new methods</li>                  <li>Aggregates multiple passive DNS sources</li>                  <li>Provides WHOIS data </li>                  <li>Provides references to OpenSource reporting</li>                  <li>Also has TLS certificates</li>                  <li>So much more I am only touching the surface</li>                </ul>              </section>              <section>                <h3>If you aren't you using it</h3>                <h3>You really should try it out</h3>                <h3> You won't regret it </h3>                <p>Disclamer: PassiveTotal provided me researcher access for data required for this presentation</p>              </section>            </section>            <section>              <section>                <h2> Some basic examples using PassiveTotal, Censys.io or a local sonar datastore</h2>              </section>              <section>                <h3>What certificates have been seen on 185.12.44.51 </h3>                  <p>Source: PassiveTotal</p>                  <img data-src='images/pt_basic_ip.png'>              </section>              <section>                <p>Where is <strong>a1833c32d5f61d6ef9d1bb0133585112069d770e</strong> currently seen </p>                <p>Source: Censys.io</p>                  <img data-src='images/censys_basic_cert.png'>              </section>              <section>                <h3>Self Signed Certificates in an ASN with Amazon in the name</h3>                <p>Source: Censys.io</p>                <img data-src='images/censys_asn_selfsigned.png'>              </section>              <section>                <h3> Certificates signed by Wosign that have Microsoft in the subject <h3>                  <p>Source: My sonar es instance</p>                  <img data-src='images/sonar_basic_wosign.png'>            </section>          </section>              <!-- threat actor -->              <section>                <h2> Now that you have seen some very basic examples</h2>              </section>              <section>                <h2>Let's do some TLS hunting/pivoting</h2>              </section>                <section>                  <img data-src='images/down_by_the_river.gif'>                </section>              <section>                <section>                <h3>CVE-2014-1761</h3>                <h3>Remote Code Execution - Word RTF Memory Corruption Vulnerability </h3>              </section>              <section>                <h3>Awesome <a href="https://blogs.technet.microsoft.com/srd/2014/03/24/security-advisory-2953095-recommendation-to-stay-protected-and-for-detections/" target="_blank">technet</a> article that provided the following:</h3>                <h3>Yara Sigs!</h3>                <h3>TLS SHA1 Hash</h3>                <h3>Command and Control IP</h3>                <h3>Potential Command and Control Domain</h3>              </section>              <section>                <h3>Starting point</h3>                <img data-src='images/ms_technet_starting.jpg'>              </section>              <section>                <h3>Let's do some traditional pivots</h3>                <p>Passive DNS records that were active around time of Microsoft report</p>                <p>Whois on domain provided</p>                <p>Repeat two steps above on any new info found</p>              </section>              <section>                <img data-src='images/ms_technet_tradtional.jpg'>              </section>              <section>                <h3>Now let's pivot on the TLS SHA1</h3>                <p>SHA1: df7240fb9bcd5312eba5f9c2dde7a29a1dc8f355 </p>              </section>              <section>                <img data-src='images/ms_technet_sslfirst.jpg'>              </section>              <section>                <h3>Timeline</h3>             <img data-src='images/ms_timeline.jpg'>              </section>            <section>              <h3>Success!!!!</h3>              <br>              <h3>Go from one TLS Cert, one IP, and one Domain</h3>              <br>              <h3>Get 6 IPs and Three Domains using same registration info</h3>              <br>            </section>            <section data-background="images/happy_dance_2.gif">            </section>          </section>          <section>              <section>               <h3>Palo Alto - Lotus Blossom </h3>               <img data-src='images/oplotusblossom.png'>              </section>              <section>                <p>Great write up on targeting of Hong Kong, Taiwan, Vietnam, the Philippines, and Indonesia and the use of the Elise trojan</p>                <p>Provided csv of  iocs on <a href='https://github.com/pan-unit42/iocs/tree/master/lotusblossom' target="_blank">github</a></p>              </section>              <section>                <h3>IP iocs</h3>                <img data-src='images/oplotus_ips_start.jpg'>              </section>              <section>                <h3>TLS Pivot</h3>                <img data-src='images/oplotus_ssl_first.jpg'>              </section>              <section>                <h3>Hmmm several ip's all using the same TLS cert</h3>                <h3>Could there be more?</h3>                </section>                <section>                  <img data-src='images/lotusblossom_311.png'>                </section>                <section>                  <h3>Yup! there is more - lots more</h3>                  <h3> 311 more as of 8/15/2016 </h3>                  <br>                  <h3>Certificate Issuer: Eric-Office </h3>                  <h3> Certificate Subject: Eric-Office </h3>                  <h3> Validity Dates: 2012-02-13 - 2022-02-10 </h3>                </section>                <section>                  <h3>Sonar dates </h3>                  <h3> First seen 2013-10-30 </h3>                  <h3> Last seen 2016-08-15 </h3>                  <br>                  <h3>Still very active today</h3>                </section>          </section>          <section>              <section>                <h3> APT 28/Sofacy - X Tunnel </h3>                <img data-src='images/apt28_headline.png'>              </section>              <section>                <h3> Initial IOC</h3>                <img data-src='images/apt28_iocs.jpg'>            </section>            <section>              <h3> Passive DNS pivot </h3>              <img data-src='images/apt28_trad_pivot.jpg'>            </section>            <section>              <h3> TLS Certificate pivot on initial IP addresses</h3>              <img data-src='images/apt28_ssl_first_pivot.jpg'>            </section>            <section>              <h3>Certificate #1              <img data-src='images/apt28_loginvk.png'>            </section>            <section>              <h3>Certificate #2 </h3>                          <img data-src='images/apt28_crook.png'>            </section>            <section>              <h4> Pivot on certificate #2 </h4>              <img data-src='images/apt28_ssl_second_pivot.jpg'>            </section>            <section>              <h3>Crowd Strike DNC Report </h3>              <img data-src='images/apt28_crowdstrike.png'>            </section>            <section>              <h3>Timeline</h3>              <p> An overall picture of how long this certificate has been seen by IP</p>            </section>            <section>             <img data-src='images/apt28_timeline.jpg'>              </section>            <section>              <h4> Initial report 2 domains, 2 IPs, 1 TLS Cert </h4>                <h4> Tradtional pivots reveal 5 interesting domains</h4>              <h4> Now have 24 IPs, 7 domains, 3 TLS certs <h4>              <h4>Additional linkages via open source reporting</h4>            </section>            <section>              <h4><strong> If you aren't monitoring for this certificate</strong></h4>              <h4><strong>a1833c32d5f61d6ef9d1bb0133585112069d770e </strong></h4>              <h4><strong> You probably should :) </strong></h4>            </section>          </section>          <section>            <section>              <h3> PWC Poland <font color="red">Red</font> Team  </h3>            </section>            <section>              <p>Inital indicators were several malicious hashes that were shared with me</p>              <p>What piqued my interest was the malware in a few cases was attempting to use DNS to tunnel once running</p>            </section>            <section>              <img data-src='images/pwc_red_intial.png'>            </section>            <section>              <h3>Passive DNS Pivot on C2 domain </h3>              <img data-src='images/pwc_redteam_domain_pivot.png'>            </section>            <section>              <h3>Passive DNS pivot on new IP addresses </h3>              <img data-src='images/pwc_redteam_ip_pivot.png'>            </section>            <section>              <h3>SSL pivot on IP addresses</h3>              <img data-src='images/pwc_redteam_ip_ssl.png'>            </section>            <section>              <h3>Three ssl certificates to look at </h3>            </section>            <section>              <h3>Certifcate #1 </h3>              <img data-src='images/pwc_redteam_ssl1.png'>            </section>            <section>              <h3>Certifcate #2 </h3>              <img data-src='images/pwc_redteam_ssl2.jpg'>            </section>            <section>              <h3>Certifcate #3 </h3>              <img data-src='images/pwc_redteam_ssl3.jpg'>            </section>            <section>              <h3>Pivot on the newly discovered TLS certificates </h3>            </section>            <section>              <img data-src='images/pwc_redteam_ssl_pivot.png'></h3>            </section>            <section>              <h3>What did we find</h3>              <ul>                <li>Three new IP addresses</li>                <li>Cert #1 was seen on all five of the original IPs</li>                  <ul><li>It was also seen on one new IP</li></ul>                <li>Cert #2 was seen on four of the five original IPs</li>                <ul><li>It was also seen on the same new cert as #1 and two addtional IPs</li></ul>                <li>Cert #3 was the same four of the five original IPs as #2</li>                <ul><li>It was also seen on the same new cert as #1 and the two addtional IPs as #2</li></ul>              </ul>            </section>            <section>              <p>We could have found all of this infrastucture with out doing the certificate pivoting</p>                <p>Multiple passive dns pivots would have eventually                gotten us to this point </p><p>The certificate pivoting helped connect the dots in the relations of all the infrastructure</p>            </section>            <section>              <h3> Thank You </h3>              <p> To the PWC Poland <font color='red'>red</font> team for being good sports and allowing me to mention their infrastructure in this talk</p>            </section>          </section>            <section>              <section>                <h3>PoSeidon  - Point of Sale</h3>                <img data-src='images/talos_headline.jpg'>                <img data-src='images/talos_pos_logo.jpg'>              </section>              <section>                <h3>Initial IOCs</h3>                <img data-src='images/talos_pos_initial.jpg'>              </section>              <section>                <h3>Passive DNS on domains </h3>                <img data-src='images/talos_pdns_domains.jpg'>              </section>              <section>                <h3>Pivot on TLS certificates found on IPs </h3>                <img data-src='images/talos_pos_second_ssl.jpg'>                <h3>Yeah hard to read and lots of addtional IP addresses</h3>              </section>              <section>                <h3>Three ssl certificates with decent clusters<h3>                  <h3>Lets take a look at the details of the certificates</h3>              </section>                <section>                <img data-src='images/talos_pos_ssl_details_1.png'>                <img data-src='images/talos_pos_ssl_details_2.png'>                <img data-src='images/talos_pos_ssl_details_3.png'>              </section>              <section>                <h3>Lets zoom in on the three clusters of ssl certificates</h3>              </section>              <section>                <img data-src='images/talos_ssl_cluster_1.png'>              </section>              <section>                <img data-src='images/talos_cluster_2.png'>              </section>              <section>                <img data-src='images/talos_cluster_3.png'>              </section>              <section>                <h3> Start with 18 domains, 6 ip addresses </h3>                <h3> Basic pdns pivot adds 29 new ip addresses </h3>                <h3> 3 new TLS certificates </h3>                <h3> 51 new ip addresses using those TLS certificates </h3>              </section>              <section>                <h3>Much more to dig into </h3>                <p>More pivots to be done but I will leave this as an exercise for you to try </p>              </section>            </section>            <section>              <h3>Summary </h3>              <ul>                <li>Add SSL cert pivoting to your network infrastructure pivots for addtional data sources</li>                <li>Add SSL certificates to network defenses where appropriate</li>                <li>Use opensource data to find SSL certificates for your enivornment that you might be unaware of</li>                <li>Happy Pivoting!</li>              </ul>            </section>              <section>                <h2> Questions? </h2>              </section>            </div>        </div>        <script src="js/head.min.js"></script>        <script src="js/reveal.js"></script>        <script>        var gaPropertyID = 'UA-76781477-1';        Reveal.initialize({          controls: true,          history: true,          dependencies: [       // Zoom in and out with Alt+click       { src: 'plugin/zoom-js/zoom.js', async: true },       // Speaker notes       { src: 'plugin/notes/notes.js', async: true },      // {src: 'plugin/reveal-ga.min.js'},       { src: 'plugin/external/external.js', condition: function() { return !!document.querySelector( '[data-external]' ); } },        {src: 'plugin/reveal-ga.min.js'}   ]        });        </script></html>